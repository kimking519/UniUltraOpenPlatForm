{% extends "layout.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>4. 需求管理 (uni_quote)</h1>
    {% if current_user.rule == '3' or current_user.rule == '0' %}
    <div style="display: flex; gap: 1rem;">
        <button class="btn btn-primary" onclick="toggleModal('importModal')"
            style="background: var(--light); color: var(--text); border: 1px solid var(--border);">+ 批量导入</button>
        <button class="btn btn-primary" onclick="toggleModal('addModal')">+ 新增需求</button>
    </div>
    {% endif %}
</div>

<!-- Search Bar -->
<div class="card" style="margin-bottom: 1rem; padding: 1rem;">
    <form method="get" action="/quote" style="display: flex; gap: 1rem;">
        <input type="text" name="search" placeholder="搜索型号、客户、需求编号..." value="{{ search }}"
            style="flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
        <button type="submit" class="btn btn-primary">搜索</button>
        {% if search %}
        <a href="/quote" class="btn"
            style="background: var(--light); color: var(--secondary); text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px;">清除</a>
        {% endif %}
    </form>
</div>

<div class="card" style="padding: 0;">
    <div class="table-container" style="overflow-x: auto;">
        <table class="data-table" style="min-width: 1500px;">
            <thead>
                <tr>
                    <th style="min-width: 140px;">需求编号</th>
                    <th style="min-width: 100px;">需求日期</th>
                    <th style="min-width: 120px;">客户名称</th>
                    <th style="min-width: 150px;">询价型号</th>
                    <th style="min-width: 150px;">报价型号</th>
                    <th style="min-width: 100px;">询价品牌</th>
                    <th style="min-width: 80px;">需求数量</th>
                    <th style="min-width: 100px;">目标价(¥)</th>
                    <th style="min-width: 100px;">成本价(¥)</th>
                    <th style="min-width: 250px;">需求组合信息 (系统自动汇总)</th>
                    <th style="min-width: 150px;">备注</th>
                    {% if current_user.rule == '3' %}
                    <th style="min-width: 120px; position: sticky; right: 0; background: white; z-index: 1;">操作</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for row in items %}
                <tr>
                    <td>{{ row.quote_id }}</td>
                    <td>{{ row.quote_date }}</td>

                    {% if current_user.rule == '3' or current_user.rule == '0' %}
                    <td ondblclick="makeEditableSelect(this, '{{ row.quote_id }}', 'cli_id', '{{ row.cli_id }}')">
                        <span>{{ row.cli_name }}</span>
                    </td>
                    <td ondblclick="makeEditable(this, '{{ row.quote_id }}', 'inquiry_mpn')"><span>{{ row.inquiry_mpn
                            }}</span></td>
                    <td ondblclick="makeEditable(this, '{{ row.quote_id }}', 'quoted_mpn')"><span>{{ row.quoted_mpn
                            }}</span></td>
                    <td ondblclick="makeEditable(this, '{{ row.quote_id }}', 'inquiry_brand')"><span>{{
                            row.inquiry_brand }}</span></td>
                    <td ondblclick="makeEditable(this, '{{ row.quote_id }}', 'inquiry_qty', 'number')"><span>{{
                            row.inquiry_qty }}</span></td>
                    <td ondblclick="makeEditable(this, '{{ row.quote_id }}', 'target_price_rmb', 'number')"><span>{{
                            row.target_price_rmb }}</span></td>
                    <td ondblclick="makeEditable(this, '{{ row.quote_id }}', 'cost_price_rmb', 'number')"><span>{{
                            row.cost_price_rmb }}</span></td>
                    <td style="color: var(--secondary); font-size: 0.85rem;">{{ row.combined_info }}</td>
                    <td ondblclick="makeEditable(this, '{{ row.quote_id }}', 'remark')"><span>{{ row.remark }}</span>
                    </td>
                    {% else %}
                    <td>{{ row.cli_name }}</td>
                    <td>{{ row.inquiry_mpn }}</td>
                    <td>{{ row.quoted_mpn }}</td>
                    <td>{{ row.inquiry_brand }}</td>
                    <td>{{ row.inquiry_qty }}</td>
                    <td>{{ row.target_price_rmb }}</td>
                    <td>{{ row.cost_price_rmb }}</td>
                    <td style="color: var(--secondary); font-size: 0.85rem;">{{ row.combined_info }}</td>
                    <td>{{ row.remark }}</td>
                    {% endif %}

                    {% if current_user.rule == '3' %}
                    <td style="position: sticky; right: 0; background: white; z-index: 1;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <!-- Phase 3 Offer Transition Button placeholder -->
                            <!-- <button class="btn" onclick="transToOffer('{{ row.quote_id }}')" style="padding: 0.2rem 0.5rem; font-size: 0.8rem; background: var(--secondary); color: white;">转报价</button> -->
                            <button class="btn"
                                style="padding: 0.2rem 0.5rem; font-size: 0.8rem; background: #ef4444; color: white;"
                                onclick="deleteRow('{{ row.quote_id }}')">删除</button>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr>
                    <td colspan="12" style="text-align: center; color: var(--secondary); padding: 2rem;">暂无需求记录，请添加新需求。
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div
        style="padding: 1rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
        <span style="color: var(--secondary); font-size: 0.9rem;">共 {{ total }} 条记录</span>
        <div style="display: flex; gap: 0.5rem;">
            {% if page > 1 %}
            <a href="/quote?page={{ page - 1 }}&search={{ search }}" class="btn"
                style="padding: 0.3rem 0.8rem; text-decoration: none; color: var(--text); border: 1px solid var(--border);">上一页</a>
            {% endif %}
            <span style="padding: 0.3rem 0.8rem; background: var(--primary); color: white; border-radius: 4px;">{{ page
                }} / {{ total_pages if total_pages > 0 else 1 }}</span>
            {% if page < total_pages %} <a href="/quote?page={{ page + 1 }}&search={{ search }}" class="btn"
                style="padding: 0.3rem 0.8rem; text-decoration: none; color: var(--text); border: 1px solid var(--border);">
                下一页</a>
                {% endif %}
        </div>
    </div>
</div>

<!-- Add Modal -->
<div id="addModal" class="modal-overlay" style="display: none;">
    <div class="card" style="width: 500px; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 1.5rem;">新增需求</h3>
        <form action="/quote/add" method="post" style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">客户名称*</label>
                <select name="cli_id" required
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                    <option value="">-- 请选择关联客户 --</option>
                    {% for c in cli_list %}
                    <option value="{{ c.cli_id }}">{{ c.cli_name }} ({{ c.region }})</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">询价型号 (Inquiry MPN)*</label>
                <input type="text" name="inquiry_mpn" required
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">报价型号 (Quoted MPN)</label>
                <input type="text" name="quoted_mpn"
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">询价品牌</label>
                <input type="text" name="inquiry_brand"
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 1rem;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">询价数量</label>
                    <input type="number" name="inquiry_qty" value="0"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">目标价(¥)</label>
                    <input type="number" step="0.01" name="target_price_rmb" value="0.0"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">成本价(¥)</label>
                    <input type="number" step="0.01" name="cost_price_rmb" value="0.0"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                </div>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">备注</label>
                <textarea name="remark"
                    style="width: 100%; height: 60px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;"></textarea>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                <button type="button" class="btn" onclick="toggleModal('addModal')">取消</button>
                <button type="submit" class="btn btn-primary">提交</button>
            </div>
        </form>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal-overlay" style="display: none;">
    <div class="card" style="width: 90%; max-width: 600px;">
        <h3 style="margin-bottom: 1.5rem;">批量导入需求表数据</h3>

        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--light); border-radius: 4px;">
            <p style="margin-top: 0; margin-bottom: 0.5rem; font-weight: 500;">方式一：上传 CSV 文件 (推荐)</p>
            <p style="font-size: 0.85rem; color: var(--secondary); margin-bottom: 1rem;">
                1. 点击这里 <a href="/static/template_quote.csv" download
                    style="color: var(--primary); font-weight: 600;">下载 Excel 标准模板 (CSV格式)</a><br>
                2. 在 Excel 中用该模板录入数据并保存<br>
                3. 上传保存的模板文件
            </p>
            <form action="/quote/import/csv" method="post" enctype="multipart/form-data"
                style="display: flex; gap: 1rem; align-items: center;">
                <input type="file" name="csv_file" accept=".csv" required
                    style="flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                <button type="submit" class="btn btn-primary">上传并导入</button>
            </form>
        </div>

        <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 4px;">
            <p style="margin-top: 0; margin-bottom: 0.5rem; font-weight: 500;">方式二：粘贴文本导入</p>
            <p style="font-size: 0.85rem; color: var(--secondary); margin-bottom: 1rem;">
                格式要求与模板一致：<br>客户编号,询价型号,报价型号,询价品牌,询价数量,目标价,成本价,备注<br>
                (注: 客户编号必须事先存在于系统中，如 C001)
            </p>
            <form action="/quote/import" method="post">
                <textarea name="batch_text" rows="10" placeholder="C001,STM32F103C8T6,,ST,500,8.5,7.0,急单"
                    style="width: 100%; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem; margin-bottom: 1rem; font-family: monospace;"></textarea>
                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn" onclick="toggleModal('importModal')">取消</button>
                    <button type="submit" class="btn btn-primary" style="background: var(--text);">文本导入</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const cliOptions = `
        <option value="">--择客户--</option>
        {% for c in cli_list %}
        <option value="{{ c.cli_id }}">{{ c.cli_name }}</option>
        {% endfor %}
    `;

    function toggleModal(id) {
        const modal = document.getElementById(id);
        modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
    }

    function makeEditable(td, quote_id, field, inputType = 'text') {
        if (td.querySelector('input')) return;
        const isSpan = td.querySelector('span') !== null;
        const originalValue = (isSpan ? td.querySelector('span').innerText : td.innerText).trim();
        td.innerHTML = `<input type="${inputType}" value="${originalValue}" style="width: 100%; min-width: 80px; padding: 4px; box-sizing: border-box;">`;
        const input = td.querySelector('input');
        input.focus();

        input.onblur = () => saveEdit(td, quote_id, field, input.value, originalValue);
        input.onkeydown = (e) => {
            if (e.key === 'Enter') input.blur();
            if (e.key === 'Escape') td.innerHTML = `<span>${originalValue}</span>`;
        };
    }

    function makeEditableSelect(td, quote_id, field, originalId) {
        if (td.querySelector('select')) return;
        const originalText = td.querySelector('span').innerText;
        td.innerHTML = `<select style="width: 100%; padding: 4px; box-sizing: border-box;">${cliOptions}</select>`;
        const select = td.querySelector('select');
        select.value = originalId;
        select.focus();

        select.onblur = () => {
            if (select.value !== originalId) {
                saveEdit(td, quote_id, field, select.value, originalText, select.options[select.selectedIndex].text);
            } else {
                td.innerHTML = `<span>${originalText}</span>`;
            }
        };
        select.onkeydown = (e) => {
            if (e.key === 'Escape') td.innerHTML = `<span>${originalText}</span>`;
        };
    }

    function saveEdit(td, quote_id, field, newValue, originalValue, newText = null) {
        if (newValue === originalValue) {
            td.innerHTML = `<span>${originalValue}</span>`;
            return;
        }
        const formData = new FormData();
        formData.append('quote_id', quote_id);
        formData.append('field', field);
        formData.append('value', newValue);

        fetch('/api/quote/update', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const display = newText !== null ? newText : newValue;
                    td.innerHTML = `<span style="color: green;">${display}</span>`;
                    setTimeout(() => {
                        // Update combined info if one of its components changed
                        if (['quoted_mpn', 'inquiry_brand', 'inquiry_qty', 'remark'].includes(field)) {
                            window.location.reload();
                        } else {
                            td.innerHTML = `<span>${display}</span>`;
                        }
                    }, 1000);
                } else {
                    alert('更新失败: ' + data.message);
                    td.innerHTML = `<span>${originalValue}</span>`;
                }
            });
    }

    function deleteRow(quote_id) {
        if (confirm(`确定要删除需求 ${quote_id} 吗？`)) {
            const formData = new FormData();
            formData.append('quote_id', quote_id);
            fetch('/api/quote/delete', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) window.location.reload();
                    else alert('删除失败: ' + data.message);
                });
        }
    }
</script>
{% endblock %}