{% extends "layout.html" %}
{% block content %}
<div class="header-action">
    <h2>7. 销售订单管理 (uni_order)</h2>
    <div style="display: flex; gap: 0.5rem;">
        <button class="btn btn-primary" onclick="batchToBuy()"
            style="background: #3b82f6; color: white; border: 1px solid #3b82f6;">批量转采购</button>
        <button class="btn btn-primary" onclick="showImportModal()">批量导入</button>
        <button class="btn btn-primary" onclick="showAddModal()">+ 新增销售订单</button>
    </div>
</div>

<div class="filter-bar card"
    style="margin-top: 1rem; margin-bottom: 1rem; display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
    <div>
        <label>客户</label>
        <select id="filter_cli" onchange="applyFilter()" style="padding: 0.4rem;">
            <option value="">全部客户</option>
            {% for c in cli_list %}
            <option value="{{ c.cli_id }}" {% if cli_id==c.cli_id %}selected{% endif %}>{{ c.cli_name }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label>开始日期</label>
        <input type="date" id="start_date" value="{{ start_date }}" style="padding: 0.4rem;">
    </div>
    <div>
        <label>结束日期</label>
        <input type="date" id="end_date" value="{{ end_date }}" style="padding: 0.4rem;">
    </div>
    <div>
        <label>搜索</label>
        <input type="text" id="search_input" value="{{ search }}" placeholder="订单号/型号..." style="padding: 0.4rem;">
    </div>
    <button class="btn btn-primary" onclick="applyFilter()">查询</button>
</div>

<div class="batch-actions" style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem;">
    <button class="btn" onclick="batchExport()">批量导出 CSV</button>
    <button class="btn" style="color: red;" onclick="batchDelete()">批量删除</button>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th><input type="checkbox" id="select_all" onclick="toggleSelectAll(this.checked)"></th>
                <th>订单编号</th>
                <th>日期</th>
                <th>客户</th>
                <th>报价编号</th>
                <th>报价型号</th>
                <th>品牌</th>
                <th>完结状态</th>
                <th>付款状态</th>
                <th>已付金额</th>
                <th>备注</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr data-id="{{ item.order_id }}">
                <td><input type="checkbox" class="row-checkbox" value="{{ item.order_id }}"></td>
                <td>{{ item.order_id }}</td>
                <td>{{ item.order_date }}</td>
                <td>{{ item.cli_name }}</td>
                <td>{{ item.offer_id }}</td>
                <td onclick="editField('{{ item.order_id }}', 'inquiry_mpn', '{{ item.inquiry_mpn }}')"
                    style="cursor: pointer; color: var(--primary);">{{ item.inquiry_mpn }}</td>
                <td onclick="editField('{{ item.order_id }}', 'inquiry_brand', '{{ item.inquiry_brand }}')"
                    style="cursor: pointer; color: var(--primary);">{{ item.inquiry_brand }}</td>
                <td>
                    <label class="switch">
                        <input type="checkbox" {% if item.is_finished==1 %}checked{% endif %}
                            onchange="toggleStatus('{{ item.order_id }}', 'is_finished', this.checked)">
                        <span class="slider"></span>
                    </label>
                </td>
                <td>
                    <label class="switch">
                        <input type="checkbox" {% if item.is_paid==1 %}checked{% endif %}
                            onchange="toggleStatus('{{ item.order_id }}', 'is_paid', this.checked)">
                        <span class="slider"></span>
                    </label>
                </td>
                <td onclick="editField('{{ item.order_id }}', 'paid_amount', '{{ item.paid_amount }}')"
                    style="cursor: pointer; color: var(--primary);">
                    {{ item.paid_amount }}
                </td>
                <td onclick="editField('{{ item.order_id }}', 'remark', '{{ item.remark }}')" style="cursor: pointer;">
                    {{ item.remark }}
                </td>
                <td>
                    <button class="btn" style="color: red; padding: 2px 8px;"
                        onclick="deleteOrder('{{ item.order_id }}')">删除</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="pagination" style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center;">
    {% if page is defined and page > 1 %}
    <a href="/order?page={{ page-1 }}&search={{ search }}&cli_id={{ cli_id }}&start_date={{ start_date }}&end_date={{ end_date }}"
        class="btn">上一页</a>
    {% endif %}
    <span>第 {{ page if page is defined else 1 }} / {{ total_pages if total_pages is defined else 1 }} 页 (共 {{ total if
        total is defined else 0 }} 条)</span>
    {% if page is defined and total_pages is defined and page < total_pages %} <a
        href="/order?page={{ page+1 }}&search={{ search }}&cli_id={{ cli_id }}&start_date={{ start_date }}&end_date={{ end_date }}"
        class="btn">下一页</a>
        {% endif %}
</div>

<!-- Add Modal -->
<div id="addModal" class="modal-overlay" style="display:none;">
    <div class="card" style="width: 500px;">
        <h3>新增销售订单</h3>
        <form action="/order/add" method="post"
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
            <div style="grid-column: span 2;">
                <label>客户</label><br>
                <select name="cli_id" required style="width: 100%; padding: 0.5rem;">
                    {% for c in cli_list %}
                    <option value="{{ c.cli_id }}">{{ c.cli_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>订单编号 (可选)</label><br>
                <input type="text" name="order_id" placeholder="自动生成" style="width: 100%; padding: 0.5rem;">
            </div>
            <div>
                <label>报价编号 (可选)</label><br>
                <input type="text" name="offer_id" style="width: 100%; padding: 0.5rem;">
            </div>
            <div>
                <label>报价型号</label><br>
                <input type="text" name="inquiry_mpn" style="width: 100%; padding: 0.5rem;">
            </div>
            <div>
                <label>品牌</label><br>
                <input type="text" name="inquiry_brand" style="width: 100%; padding: 0.5rem;">
            </div>
            <div>
                <label>已付金额</label><br>
                <input type="number" step="0.01" name="paid_amount" value="0.0" style="width: 100%; padding: 0.5rem;">
            </div>
            <div style="grid-column: span 2;">
                <label>备注</label><br>
                <textarea name="remark" style="width: 100%; padding: 0.5rem;"></textarea>
            </div>
            <div style="grid-column: span 2; display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn btn-primary">提交</button>
                <button type="button" class="btn" onclick="toggleModal('addModal')">取消</button>
            </div>
        </form>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal-overlay" style="display:none;">
    <div class="card" style="width: 600px;">
        <h3>批量导入订单 (支持报价 CSV 内容)</h3>
        <form action="/order/import" method="post" enctype="multipart/form-data"
            style="margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem;">
            <div>
                <label>选择所属客户</label><br>
                <select name="cli_id" required style="width: 100%; padding: 0.5rem;">
                    {% for c in cli_list %}
                    <option value="{{ c.cli_id }}">{{ c.cli_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="padding: 1rem; border: 1px dashed var(--border); border-radius: 8px; background: #f8fafc;">
                <p style="font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: bold;">方式一：上传 CSV 文件</p>
                <input type="file" name="csv_file" accept=".csv">
            </div>

            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <p style="font-size: 0.9rem; font-weight: bold;">方式二：手输/粘贴文本 (包含表头)</p>
                <textarea name="batch_text" placeholder="报价编号,日期,需求编号,询价型号,报价型号,询价品牌,报价品牌..."
                    style="width: 100%; height: 150px; padding: 0.5rem;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn btn-primary">开始导入</button>
                <button type="button" class="btn" onclick="toggleModal('importModal')">取消</button>
            </div>
        </form>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
    }
</style>

<script>
    async function batchToBuy() {
        const selected = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            alert('请先选择要转换的销售订单');
            return;
        }

        if (!confirm(`确定要把选中的 ${selected.length} 条销售订单转为采购记录吗？`)) return;

        try {
            const response = await fetch('/api/order/batch_to_buy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: selected })
            });

            const data = await response.json();
            if (data.success) {
                alert(data.message);
                window.location.href = '/buy';
            } else {
                alert('转换失败: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('请求失败，请稍后重试');
        }
    }

    function toggleModal(id) {
        const modal = document.getElementById(id);
        modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
    }

    function showAddModal() { toggleModal('addModal'); }
    function showImportModal() { toggleModal('importModal'); }

    function applyFilter() {
        const cli = document.getElementById('filter_cli').value;
        const search = document.getElementById('search_input').value;
        const start = document.getElementById('start_date').value;
        const end = document.getElementById('end_date').value;
        window.location.href = `/order?cli_id=${cli}&search=${search}&start_date=${start}&end_date=${end}`;
    }

    function toggleSelectAll(checked) {
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = checked);
    }

    function getSelectedIds() {
        return Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);
    }

    async function batchDelete() {
        const ids = getSelectedIds();
        if (ids.length === 0) return alert('请选择要删除的记录');
        if (!confirm(`确定删除选中的 ${ids.length} 个订单吗？`)) return;

        const resp = await fetch('/api/order/batch_delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids })
        });
        const res = await resp.json();
        if (res.success) window.location.reload();
        else alert(res.message);
    }

    async function batchExport() {
        const ids = getSelectedIds();
        if (ids.length === 0) return alert('请选择要导出的记录');

        const resp = await fetch('/api/order/export_csv', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids })
        });
        const res = await resp.json();
        if (res.success) {
            const blob = new Blob([res.csv_content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `order_export_${new Date().getTime()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else alert(res.message);
    }

    async function toggleStatus(orderId, field, value) {
        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('field', field);
        formData.append('value', value ? 1 : 0);

        const resp = await fetch('/api/order/update_status', { method: 'POST', body: formData });
        const res = await resp.json();
        if (!res.success) alert(res.message);
    }

    async function editField(orderId, field, currentVal) {
        const newVal = prompt(`修改 ${field}:`, currentVal);
        if (newVal === null || newVal === currentVal) return;

        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('field', field);
        formData.append('value', newVal);

        const resp = await fetch('/api/order/update', { method: 'POST', body: formData });
        const res = await resp.json();
        if (res.success) window.location.reload();
        else alert(res.message);
    }

    async function deleteOrder(orderId) {
        if (!confirm('确定删除订单 ' + orderId + ' 吗？')) return;
        const formData = new FormData();
        formData.append('order_id', orderId);
        const resp = await fetch('/api/order/delete', { method: 'POST', body: formData });
        const res = await resp.json();
        if (res.success) window.location.reload();
        else alert(res.message);
    }
</script>
{% endblock %}